<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>INVERSIONES NK - BOLETA DE PEDIDO</title>
    <link rel="icon" href="https://github.com/rimedhn/inversionesnk/blob/main/Logo%20corto%20InvNK.png?raw=true" type="image/x-icon">
    <style type="text/css">
      body {
        margin: 0;
        padding: 0;
        background-color: #f0f0f0;
      }
      #letter-size {
        width: 5.5in;
        min-height: 7in;
        margin: 0.2in auto;
        padding: 10px;
        font-family: Arial, sans-serif;
        background-color: #fff;
        font-size: 10px;
      }
      @media print {
        body {
          margin: 0;
          padding: 0;
          -webkit-print-color-adjust: exact;
          color-adjust: exact;
        }
        @page {
          margin-top: 0.5in;
          margin-bottom: 0.5in;
          margin-left: 0.5in;
          margin-right: 0.5in;
          size: letter;
        }
        #letter-size {
          width: 100%;
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          font-size: 10px;
        }
        table { page-break-inside: auto; }
        tr { page-break-inside: avoid; page-break-after: auto; }
        thead { display: table-header-group; }
        tfoot { display: table-footer-group; }
      }
      .label { text-align: center; font-size: 18px; margin-bottom: 10px; }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 15px;
      }
      table th,
      table td {
        border: 1px solid black;
        padding: 6px;
        text-align: left;
        vertical-align: top;
      }
      .sin-bordes, .sin-bordes th, .sin-bordes td { border: none !important; }
      #tabla-encabezado .logo-container { width: 20%; text-align: center; vertical-align: middle; }
      #tabla-encabezado .empresa-info-container { width: 80%; vertical-align: middle; }
      #tabla-encabezado .empresa-info-container b, #tabla-encabezado .empresa-info-container span { font-size: 10px; }
      #tabla-encabezado .empresa-info-container b#empresa { font-size: 20px; display: block; margin-bottom: 4px; color: #333; }
      #letter-size span#email-content {
        display: inline-block;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
        max-width: 98%;
        vertical-align: top;
      }
      #tabla-cliente-factura th { text-align: center; font-weight: bold; background-color: #e9e9e9; font-size: 11px; padding: 8px; }
      #tabla-cliente-factura td > div { padding: 5px; }
      #tabla-cliente-factura td { word-break: break-word; }
      #tabla-productos thead th {
        text-align: center;
        font-weight: bold;
        background-color: #e9e9e9;
        font-size: 10px;
        padding: 7px;
      }
      #tabla-productos tbody td { font-size: 10px; text-align: right; }
      #tabla-productos tbody td.descripcion-producto { text-align: left; word-wrap: break-word; white-space: normal; }
      #tabla-productos tbody td.cantidad-producto { text-align: center; }
      #tabla-productos h2 { font-size: 10px; text-align: center; line-height: 1.2; margin: 0; font-weight: bold; }
      #tabla-totales-observaciones .info-adicional { font-size: 9.5px; vertical-align: top; }
      #tabla-totales-observaciones .info-adicional hr { border: none; border-top: 1px dashed #888; margin: 6px 0; }
      #tabla-totales-observaciones .etiquetas-totales { text-align: right; font-weight: normal; }
      #tabla-totales-observaciones .valores-totales { text-align: right; }
      #tabla-totales-observaciones .etiquetas-totales b, #tabla-totales-observaciones .valores-totales b { font-weight: bold; }
      #montoLetrasTotal, #agradecimientoFooter {
        text-align: center;
        font-size: 10px;
        padding: 8px;
        border-top: 1px solid black;
      }
      #montoLetrasTotal {
        border-bottom: 1px solid black;
        margin-bottom: 10px;
        word-wrap: break-word;
        white-space: normal;
      }
      #montoLetrasTotal span { font-weight: bold; }
      #agradecimientoFooter { border-bottom: 1px solid black; margin-bottom: 10px; }
      #tabla-footer td { font-size: 9px; vertical-align: middle; }
      #tabla-footer .info-contacto-footer { text-align: left; }
      #tabla-footer .barcode-footer { text-align: right; }
      #tabla-footer img#barcode { max-width: 100%; height: auto; max-height: 45px; }
      #letter-size h2#tipodoc-header {
        font-size: 18px;
        text-align: center;
        margin: 0 0 10px 0;
        font-weight: bold;
        color: #000;
      }
      .mi-imagen {
        width: 90px;
        height: auto;
        max-height: 90px;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  </head>
  <body>
    <div id="letter-size">
      <table id="tabla-encabezado" class="sin-bordes">
        <tr>
          <td class="logo-container">
            <img src="https://github.com/rimedhn/inversionesnk/blob/main/Logo%20corto%20InvNK.png?raw=true" alt="Logo INVERSIONES NK" class="mi-imagen" onerror="this.style.display='none'"/>
          </td>
          <td class="empresa-info-container">
            <b id="empresa"></b>
            <b id="razon"></b> <b>RTN: <span id="rtn"></span></b><br />
            <b>Dirección: <span id="direccion"></span></b><br />
            <b>Teléfono: <span id="telefono"></span></b><br />
            <b>Email: <span id="email-content"></span></b>
          </td>
        </tr>
      </table>

      <table id="tabla-cliente-factura">
        <thead>
          <tr>
            <th colspan="12">
              <h2 id="tipodoc-header">BOLETA DE PEDIDO</h2>
            </th>
          </tr>
          <tr>
            <th colspan="6" style="width: 50%;">Datos del Cliente</th>
            <th colspan="6" style="width: 50%;">Datos del pedido</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="6">
              <div>
                <b>Cliente: <span id="cliente"></span></b><br />
                <b>RTN: <span id="rtncliente"></span></b><br />
                <b>Teléfono: <span id="telefonocliente"></span></b><br />
                <b>Dirección: <span id="direccioncliente"></span></b><br />
              </div>
            </td>
            <td colspan="6">
              <div>
                <b>Folio: <span id="folio"></span></b><br />
                <b>Fecha: <span id="fecha"></span></b><br />
                <b>Vendedor: <span id="vendedor"></span></b><br />
                <b>Forma de pago: <span id="formaPago"></span></b>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <table id="tabla-productos">
        <thead>
          <tr>
            <td colspan="6" style="text-align:center; font-weight:bold; background-color: #e9e9e9;">Detalle de los Productos</td>
          </tr>
          <tr>
            <th style="width: 15%;"><h2>Codigo</h2></th>
            <th style="width: 10%;"><h2>Cantidad</h2></th>
            <th style="width: 40%;"><h2>Descripcion</h2></th>
            <th style="width: 15%;"><h2>Precio</h2></th>
            <th style="width: 20%;"><h2>Monto</h2></th>
          </tr>
        </thead>
        <tbody id="productList"></tbody>
      </table>
      
      <table id="tabla-totales-observaciones">
        <tr>
          <td colspan="3" class="info-adicional" style="width: 50%;">
            Observaciones:<br />
            <span id="observacion" style="display:block; min-height: 30px; word-wrap:break-word; white-space:normal;"></span>
          </td>
          <td colspan="1" class="etiquetas-totales" style="width: 30%;">
            <b>Total Venta:</b>
          </td>
          <td colspan="2" class="valores-totales" style="width: 20%;">
            <b>L <span id="total"></span></b>
          </td>
        </tr>
      </table>
      
      <div id="montoLetrasTotal">
        TOTAL EN LETRAS: <span id="montoLetras"></span>
      </div>

      <div id="agradecimientoFooter">
        ¡Gracias por su preferencia!
      </div>

      <table id="tabla-footer" class="sin-bordes">
        <tr>
          <td class="info-contacto-footer" style="width: 70%;">
            <b>Original: Cliente, Copia: Emisor</b><br />
            <span>www.rmposhn.com</span><br /> <span>indime.hn@gmail.com</span><br /> <span>(+504) 9359-3126</span>
          </td>
          <td class="barcode-footer" style="width: 30%;">
            <canvas alt="Código de Barras de Factura" id="barcode"></canvas>
          </td>
        </tr>
      </table>
    </div>
    <script>
      // Cambia esto por tu endpoint de Google Apps Script:
      const API_URL = "https://script.google.com/macros/s/AKfycbxqs2xHhfuuK6Dwi3WNIMcKi7ua-IvL81xdtK_Sw-8q5V6JSAAE8XXEkcDMVFk8sb_5ig/exec";
      
      function formatCurrency(num) {
        if (num === null || num === undefined || String(num).trim() === "") return "0.00";
        let val = typeof num === "number" ? num : parseFloat(("" + num).replace(/,/g, ""));
        if (isNaN(val)) return "0.00";
        return val.toLocaleString('es-HN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      }

      function getQueryParam(param) {
        var urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param) || "";
      }

      // Formatea la fecha ISO a dd/mm/aaaa hh:mm:ss
      function formatFecha(fechaIso) {
        if (!fechaIso) return "";
        const d = new Date(fechaIso);
        if (isNaN(d.getTime())) return fechaIso;
        const pad = n => (n < 10 ? "0" : "") + n;
        return (
          pad(d.getDate()) + "/" +
          pad(d.getMonth()+1) + "/" +
          d.getFullYear() + " " +
          pad(d.getHours()) + ":" +
          pad(d.getMinutes()) + ":" +
          pad(d.getSeconds())
        );
      }

      // Número a letras (robusto, español)
      function numeroALetras(monto) {
        if (isNaN(monto)) return "CERO LEMPIRAS";
        let entero = Math.floor(monto);
        let decimales = Math.round((monto - entero) * 100);
        decimales = decimales < 10 ? "0" + decimales : decimales;
        let letras = numALetrasEntero(entero);
        return (letras || "CERO") + " LEMPIRAS CON " + decimales + "/100";
      }
      function numALetrasEntero(num) {
        if (num === 0) return "CERO";
        let unidades = ["", "UN", "DOS", "TRES", "CUATRO", "CINCO", "SEIS", "SIETE", "OCHO", "NUEVE"];
        let decenas = ["", "DIEZ", "VEINTE", "TREINTA", "CUARENTA", "CINCUENTA", "SESENTA", "SETENTA", "OCHENTA", "NOVENTA"];
        let especiales = {11: "ONCE", 12: "DOCE", 13: "TRECE", 14: "CATORCE", 15: "QUINCE"};
        let centenas = ["", "CIENTO", "DOSCIENTOS", "TRESCIENTOS", "CUATROCIENTOS", "QUINIENTOS", "SEISCIENTOS", "SETECIENTOS", "OCHOCIENTOS", "NOVECIENTOS"];
        let resultado = "";
        if (num === 100) return "CIEN";
        if (num > 999999) return "NÚMERO MUY GRANDE";
        let millones = Math.floor(num / 1000000);
        let restoMillones = num % 1000000;
        if (millones > 0) {
          if (millones === 1) resultado += "UN MILLON ";
          else resultado += numALetrasEntero(millones) + " MILLONES ";
        }
        let miles = Math.floor(restoMillones / 1000);
        let resto = restoMillones % 1000;
        if (miles > 0) {
          if (miles === 1) resultado += "MIL ";
          else resultado += numALetrasEntero(miles) + " MIL ";
        }
        if (resto > 0) {
          let centenasNum = Math.floor(resto / 100);
          let decenasNum = Math.floor((resto % 100) / 10);
          let unidadesNum = resto % 10;
          if (centenasNum > 0) resultado += centenas[centenasNum] + " ";
          let decenaUnida = resto % 100;
          if (decenaUnida >= 11 && decenaUnida <= 15) {
            resultado += especiales[decenaUnida] + " ";
          } else if (decenaUnida < 10) {
            resultado += unidades[decenaUnida] + " ";
          } else if (decenaUnida === 10) {
            resultado += "DIEZ ";
          } else if (decenaUnida === 20) {
            resultado += "VEINTE ";
          } else if (decenaUnida > 20 && decenaUnida < 30) {
            resultado += "VEINTI" + unidades[unidadesNum].toLowerCase() + " ";
          } else {
            resultado += decenas[decenasNum];
            if (unidadesNum > 0) resultado += " Y " + unidades[unidadesNum];
            resultado += " ";
          }
        }
        return resultado.trim();
      }

      // Lógica de consulta a Google Sheets API
      async function cargarBoleta() {
        const no_venta = getQueryParam('no_venta');
        if (!no_venta) {
          alert("Falta el parámetro no_venta en la URL.");
          return;
        }
        let response = await fetch(API_URL + "?no_venta=" + encodeURIComponent(no_venta));
        let data = await response.json();
        if (data.error) {
          alert("Error: " + data.error);
          return;
        }
        const v = data.venta;
        const productos = data.productos || [];

        // Encabezado empresa
        document.getElementById("empresa").textContent     = v["Empresa"] || "INVERSIONES NK";
        document.getElementById("razon").textContent       = v["Razon Social"] || "";
        document.getElementById("rtn").textContent         = v["RTN Empresa"] || v["RTN Negocio"] || "0401199400250";
        document.getElementById("direccion").textContent   = v["Direccion Empresa"] || v["DireccionEmpresa"] || "Col. Osorio, 2 cuadras y media del Centro de Salud La Roca, Santa Rosa de Copán, Honduras, C.A.";
        document.getElementById("telefono").textContent    = v["Telefono Empresa"] || v["TelefonoEmpresa"] || "3336-5228";
        document.getElementById("email-content").textContent = v["Email Empresa"] || v["EmailEmpresa"] || "nk.inversiones20@gmail.com";

        document.getElementById("tipodoc-header").textContent = "BOLETA DE PEDIDO";
        document.getElementById("cliente").textContent = v["NombreCliente"] || "";
        document.getElementById("rtncliente").textContent = v["RTN Cliente"] || v["RTN"] || "";
        document.getElementById("telefonocliente").textContent = v["TelefonoCliente"] || "";
        document.getElementById("direccioncliente").textContent = v["DireccionCliente"] || v["Direccion"] || "";
        document.getElementById("vendedor").textContent = v["NombreVendedor"] || "";
        document.getElementById("folio").textContent = v["No Venta"] || v["Factura"] || "";
        document.getElementById("fecha").textContent = formatFecha(v["Fecha hora"] || "");
        document.getElementById("formaPago").textContent = v["Forma de pago"] || "";
        document.getElementById("observacion").textContent = v["Observacion"] || "";

        // Renderizar productos
        let total = 0;
        const productList = document.getElementById("productList");
        productList.innerHTML = "";
        productos.forEach(function(p) {
          let codigo = p["Producto"] || p["producto"] || "";
          let cantidad = parseFloat(p["Cantidad"]) || 0;
          let descripcion = p["Descripcion"] || p["Producto"] || "";
          let precio = parseFloat(p["Precio"]) || 0;
          let monto = cantidad * precio;
          total += monto;

          let row = productList.insertRow();
          row.insertCell(0).textContent = codigo;
          row.cells[0].className = 'descripcion-producto';
          row.insertCell(1).textContent = cantidad;
          row.cells[1].className = 'cantidad-producto';
          row.insertCell(2).textContent = descripcion;
          row.cells[2].className = 'descripcion-producto';
          row.insertCell(3).textContent = formatCurrency(precio);
          row.cells[3].className = 'Price';
          row.insertCell(4).textContent = formatCurrency(monto);
          row.cells[4].className = 'Amount';
        });

        document.getElementById("total").textContent = formatCurrency(total);

        // Código de barras local usando canvas
        JsBarcode("#barcode", v["No Venta"] || v["Factura"] || "", {
          format: "CODE128", width: 2, height: 45, displayValue: false, margin: 0
        });

        // Monto en letras
        document.getElementById("montoLetras").textContent = numeroALetras(total);

        setTimeout(()=>window.print(), 600);
      }

      window.onload = cargarBoleta;
    </script>
  </body>
</html>
